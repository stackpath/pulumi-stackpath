on:
  push: {}
  workflow_dispatch: {}

jobs:
  version:
    uses: stackpath/actions/.github/workflows/semantic_version.yaml@v0.5.1

  publish_binary:
     name: publish
     runs-on: ubuntu-latest
     steps:
     - name: Checkout Repo
       uses: actions/checkout@v2
     - name: Unshallow clone for tags
       run: git fetch --prune --unshallow --tags
     - name: Install Go
       uses: actions/setup-go@v2
       with:
         go-version: ${{matrix.goversion}}
     - name: Install pulumictl
       uses: jaxxstorm/action-install-gh-release@v1.5.0
       with:
         repo: pulumi/pulumictl
     - name: Run GoReleaser
       uses: goreleaser/goreleaser-action@v2
       with:
         args: -p 3 release --rm-dist
         version: latest
     strategy:
       fail-fast: true
       matrix:
         goversion:
         - 1.21.x

  npm:
      uses: stackpath/actions/.github/workflows/npm_build.yaml@v0.2.4
      needs:
        - version
      with:
        semantic_version: ${{ needs.version.outputs.semantic_version }}
        branch_name: ${{ needs.version.outputs.branch_name }}
        directory: ./sdk/nodejs
      secrets: inherit
